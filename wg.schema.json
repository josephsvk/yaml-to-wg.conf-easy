{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "required": ["servers"],
  "additionalProperties": false,

  "properties": {
    "servers": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/server" }
    }
  },

  "$defs": {
    "cidr": {
      "type": "string",
      "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$"
    },

    "server": {
      "type": "object",
      "required": ["name", "address_v4", "port", "peers"],
      "additionalProperties": false,

      "properties": {
        "name": { "type": "string" },
        "endpoint": { "type": "string" },
        "port": { "type": "integer", "minimum": 1, "maximum": 65535 },
        "address_v4": { "$ref": "#/$defs/cidr" },

        "client_routes_default": {
          "type": "array",
          "items": { "$ref": "#/$defs/cidr" }
        },

        "peer_allowed_ips_default": {
          "type": "array",
          "items": { "$ref": "#/$defs/cidr" }
        },

        "interface_extras": {
          "type": "array",
          "items": { "type": "string" }
        },

        "peers": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/peer" }
        }
      }
    },

    "peer": {
      "type": "object",
      "required": ["name", "address"],
      "additionalProperties": false,

      "properties": {
        "name": { "type": "string" },
        "address": {
          "type": "string",
          "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}$"
        },

        "routed_subnets": {
          "type": "array",
          "items": { "$ref": "#/$defs/cidr" }
        },

        "allowed_ips": {
          "type": "array",
          "items": { "$ref": "#/$defs/cidr" }
        }
      },

      "allOf": [
        {
          "not": {
            "required": ["allowed_ips", "routed_subnets"]
          }
        }
      ]
